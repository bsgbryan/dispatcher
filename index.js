// Generated by CoffeeScript 1.7.1
(function() {
  var dispatch, instrumentor, modules, root;

  instrumentor = require('instrumentor');

  modules = {};

  dispatch = function(message, listener) {
    var req;
    req = message.action;
    if (!modules[req]) {
      modules[req] = instrumentor.instrument(req);
    }
    return modules[req](message).then(function(result) {
      if (listener != null) {
        return listener.send('response', {
          action: req,
          result: result
        });
      }
    }).fail(function(error) {
      if (listener != null) {
        return listener.send('error', {
          action: req,
          error: error
        });
      }
    }).progress(function(update) {
      if (listener != null) {
        return listener.send('progress', {
          action: req,
          update: update
        });
      }
    });
  };

  root = function(path) {
    return instrumentor.root = path;
  };

  module.exports = {
    dispatch: dispatch,
    root: root
  };

}).call(this);
