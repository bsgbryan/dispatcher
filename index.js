// Generated by CoffeeScript 1.7.1
(function() {
  var dispatch, instrument, instrumentor, modules;

  instrumentor = require('instrumentor');

  modules = {};

  dispatch = function(message, listener) {
    var req;
    req = message.action;
    if (!modules[req]) {
      modules[req] = instrumentor.instrument(req);
    }
    return modules[req](message).then(function(result) {
      if (listener != null) {
        return listener.send('resolve', {
          action: req,
          result: result
        });
      }
    }).fail(function(error) {
      if (listener != null) {
        return listener.send('fail', {
          action: req,
          error: error
        });
      }
    }).progress(function(update) {
      if (listener != null) {
        return listener.send('progress', {
          action: req,
          update: update
        });
      }
    });
  };

  instrument = function(module) {
    return instrumentor.use(module);
  };

  module.exports = {
    dispatch: dispatch,
    instrument: instrument
  };

}).call(this);
